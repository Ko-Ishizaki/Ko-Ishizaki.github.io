<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customerize_Loop_Text_Generator</title>
    <style>
        .item {
            display: flex;
            margin-bottom: 10px;
        }
        .item textarea {
            margin-right: 5px;
        }
        .item button {
            margin-left: 5px;
        }
        #templates {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Customerize_Loop_Text_Generator</h1>
    <p>If a single value is used, it is repeated; if multiple values are separated by a new line, they are used in sequence.</p>

    <div id="fields-container">
        <div class="item">
            <label>Label: </label>
            <input type="text" placeholder="例: 主語" class="field-name" value="a">
            <textarea placeholder="値を改行で入力" class="field-value" rows="4" cols="30"></textarea>
            <button class="delete">Delete</button>
        </div>
    </div>
    <button id="add-field-btn">Add Value</button>
    <br><br>
    <button id="generate-btn">Generate Text</button>

    <h2>Generated text</h2>
    <ul id="output"></ul>
    <div id="actions"></div>

    <h2>Saved Templates</h2>
    <div id="templates">
        <p>Saved templates are displayed below.</p>
        <ul id="template-list"></ul>
        <button id="clear-cache-btn">Delete all</button>
    </div>

    <script>
        const TEMPLATE_STORAGE_KEY = 'custom_text_templates';

        // 項目追加
        document.getElementById('add-field-btn').addEventListener('click', function () {
            const container = document.getElementById('fields-container');
            const newItem = document.createElement('div');
            newItem.className = 'item';
            newItem.innerHTML = `
                <label>項目: </label>
                <input type="text" placeholder="Example: subject" class="field-name">
                <textarea placeholder="Enter value on new line" class="field-value" rows="4" cols="30"></textarea>
                <button class="delete">Delete</button>
            `;
            container.appendChild(newItem);

            // 削除ボタンのイベントリスナーを追加
            newItem.querySelector('.delete').addEventListener('click', function () {
                newItem.remove();
            });
        });

        // 初期削除ボタンにイベントリスナーを追加
        document.querySelectorAll('.item .delete').forEach(button => {
            button.addEventListener('click', function () {
                button.parentElement.remove();
            });
        });

        // 文章生成
        document.getElementById('generate-btn').addEventListener('click', function () {
            const fields = Array.from(document.querySelectorAll('.item')).map(item => ({
                name: item.querySelector('.field-name').value.trim(),
                values: item.querySelector('.field-value').value.trim().split('\n').map(v => v.trim())
            }));

            const outputElement = document.getElementById('output');
            outputElement.innerHTML = ''; // 出力エリアをクリア

            // 最大行数の取得
            const maxRows = Math.max(...fields.map(field => field.values.length));
            const generatedLines = [];

            for (let i = 0; i < maxRows; i++) {
                const sentence = fields
                    .map(field => {
                        return field.values[i] !== undefined ? field.values[i] : field.values[field.values.length - 1];
                    })
                    .join(' ');

                const listItem = document.createElement('li');
                listItem.textContent = sentence;
                outputElement.appendChild(listItem);
                generatedLines.push(sentence);
            }

            // 動的ボタンを生成
            const actionsDiv = document.getElementById('actions');
            actionsDiv.innerHTML = `
                <button id="copy-btn">全行をクリップボードにコピー</button>
                <button id="save-template-btn">テンプレートとして保存</button>
            `;

            // 全行をクリップボードにコピー
            document.getElementById('copy-btn').addEventListener('click', function () {
                const allText = generatedLines.join('\n');
                navigator.clipboard.writeText(allText).then(() => {
                    alert('生成された文章をクリップボードにコピーしました！');
                }).catch(err => {
                    console.error('クリップボードへのコピーに失敗しました:', err);
                    alert('クリップボードへのコピーに失敗しました。');
                });
            });

            // テンプレートとして保存
            document.getElementById('save-template-btn').addEventListener('click', function () {
                const templateName = prompt('テンプレート名を入力してください:');
                if (templateName) {
                    saveTemplate(templateName, fields);
                    alert('テンプレートを保存しました！');
                    renderTemplateList();
                }
            });
        });

        // テンプレート保存
        function saveTemplate(name, fields) {
            const templates = getTemplates();
            templates[name] = fields;
            localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
        }

        // テンプレート取得
        function getTemplates() {
            const stored = localStorage.getItem(TEMPLATE_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        // テンプレートリストを描画
        function renderTemplateList() {
            const templates = getTemplates();
            const templateList = document.getElementById('template-list');
            templateList.innerHTML = '';

            Object.keys(templates).forEach(name => {
                const listItem = document.createElement('li');
                listItem.textContent = name;
                const loadButton = document.createElement('button');
                loadButton.textContent = 'Load';
                loadButton.addEventListener('click', () => loadTemplate(name));
                listItem.appendChild(loadButton);
                templateList.appendChild(listItem);
            });
        }

        // テンプレート読み込み
        function loadTemplate(name) {
            const templates = getTemplates();
            const fields = templates[name];
            const container = document.getElementById('fields-container');
            container.innerHTML = ''; // 現在のフィールドをクリア

            fields.forEach(field => {
                const newItem = document.createElement('div');
                newItem.className = 'item';
                newItem.innerHTML = `
                    <label>項目: </label>
                    <input type="text" class="field-name" value="${field.name}">
                    <textarea class="field-value" rows="4" cols="30">${field.values.join('\n')}</textarea>
                    <button class="delete">Delete</button>
                `;
                container.appendChild(newItem);
                newItem.querySelector('.delete').addEventListener('click', function () {
                    newItem.remove();
                });
            });
        }

        // キャッシュクリア
        document.getElementById('clear-cache-btn').addEventListener('click', function () {
            if (confirm('すべてのテンプレートを削除しますか？')) {
                localStorage.removeItem(TEMPLATE_STORAGE_KEY);
                alert('キャッシュをクリアしました！');
                renderTemplateList();
            }
        });

        // 初期テンプレートリストを描画
        renderTemplateList();
    </script>
</body>
</html>
