<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ドロップダウンHTML デモ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f7f7f7;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    table {
      border-collapse: collapse;
      width: 80%;
      margin: 20px auto;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #eee;
      position: relative; /* ヘッダー内の相対位置指定 */
    }
    /* ▼アイコン（ドロップダウンを表示するためのボタン） */
    .filter-icon {
      cursor: pointer;
      font-size: 14px;
      margin-left: 5px;
      color: #007BFF;
    }
    /* ドロップダウン部分のスタイル */
    .filter-dropdown {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      padding: 8px;
      z-index: 1000;
      width: 220px;
    }
    .filter-dropdown hr {
      margin: 8px 0;
      border: none;
      border-top: 1px solid #ccc;
    }
    .filter-dropdown input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
      padding: 4px;
    }
    .filter-item {
      margin-bottom: 4px;
    }
    .filter-item label {
      margin-left: 4px;
      font-size: 14px;
    }
    .filter-dropdown button {
      font-size: 12px;
      padding: 4px 6px;
      margin: 2px;
      cursor: pointer;
    }
    /* ソートオプション用スタイル */
    .sort-options {
      text-align: center;
      margin-bottom: 8px;
    }
    .sort-option {
      font-size: 12px;
      padding: 4px 6px;
      margin: 0 2px;
      cursor: pointer;
      background: #e6e6e6;
      border: 1px solid #ccc;
    }
    .sort-option.active {
      font-weight: bold;
      text-decoration: underline;
      background: #d0e9c6;
    }
  </style>
</head>
<body>
  <h1>ドロップダウンHTML デモ</h1>
  <table id="demoTable">
    <thead>
      <tr>
        <th>
          商品名
          <!-- ▼アイコンをクリックするとドロップダウンを表示 -->
          <span class="filter-icon" onclick="toggleFilterDropdown(0, this)">▼</span>
        </th>
        <th>価格</th>
        <th>在庫数</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>リンゴ</td><td>100円</td><td>50</td></tr>
      <tr><td>バナナ</td><td>80円</td><td>30</td></tr>
      <tr><td>リンゴ</td><td>120円</td><td>20</td></tr>
      <tr><td>オレンジ</td><td>150円</td><td>10</td></tr>
      <tr><td>バナナ</td><td>80円</td><td>40</td></tr>
      <tr><td>キウイ</td><td>200円</td><td>25</td></tr>
      <tr><td>オレンジ</td><td>150円</td><td>15</td></tr>
      <tr><td>パイナップル</td><td>300円</td><td>8</td></tr>
      <tr><td>リンゴ</td><td>100円</td><td>60</td></tr>
      <tr><td>キウイ</td><td>200円</td><td>35</td></tr>
    </tbody>
  </table>

  <script>
    // グローバル変数
    var filterDropdown = null;     // 現在表示中のドロップダウン要素
    var filterValues = [];         // 対象列に存在する重複しない値のリスト
    var selectedFilters = [];      // チェック済みのフィルタ値の配列

    // ソート用のグローバル変数
    var currentSortOrder = '';     // '', 'asc', 'desc'
    var defaultOrder = [];         // ページ読み込み時の行の順番を保存

    // ページ読み込み後、テーブルの初期状態の行順序を保存
    document.addEventListener('DOMContentLoaded', function() {
      var table = document.getElementById('demoTable');
      var tbody = table.tBodies[0];
      for (var i = 0; i < tbody.rows.length; i++) {
        defaultOrder.push(tbody.rows[i]);
      }
    });

    // 指定列（ここでは colIndex＝0）の全データから重複しない値を取得
    function initFilterValues(colIndex) {
      var table = document.getElementById('demoTable');
      var tbody = table.tBodies[0];
      var values = [];
      for (var i = 0; i < tbody.rows.length; i++) {
        var cellText = tbody.rows[i].cells[colIndex].textContent.trim();
        if (values.indexOf(cellText) === -1) {
          values.push(cellText);
        }
      }
      filterValues = values.sort();
    }

    // ドロップダウンを作成して表示
    function createFilterDropdown(colIndex, headerElem) {
      // 既に表示中のドロップダウンがあれば削除
      if (filterDropdown) {
        filterDropdown.parentNode.removeChild(filterDropdown);
      }
      filterDropdown = document.createElement('div');
      filterDropdown.className = 'filter-dropdown';

      // ★▼内に【昇順】【降順】のソートオプションを作成
      var sortDiv = document.createElement('div');
      sortDiv.className = 'sort-options';
      
      var ascBtn = document.createElement('button');
      ascBtn.textContent = '昇順';
      ascBtn.className = 'sort-option';
      ascBtn.setAttribute('data-order', 'asc');
      ascBtn.onclick = function(e) {
        e.stopPropagation();
        sortTable(0, 'asc');
        updateSortIndicatorInDropdown();
      };
      
      var descBtn = document.createElement('button');
      descBtn.textContent = '降順';
      descBtn.className = 'sort-option';
      descBtn.setAttribute('data-order', 'desc');
      descBtn.onclick = function(e) {
        e.stopPropagation();
        sortTable(0, 'desc');
        updateSortIndicatorInDropdown();
      };

      sortDiv.appendChild(ascBtn);
      sortDiv.appendChild(descBtn);
      filterDropdown.appendChild(sortDiv);

      // ソート部とフィルター部の間に仕切り線を追加
      var divider = document.createElement('hr');
      filterDropdown.appendChild(divider);

      // フィルター用：絞り込み用テキスト入力欄を作成
      var inputFilter = document.createElement('input');
      inputFilter.type = 'text';
      inputFilter.placeholder = '絞り込み...';
      inputFilter.onkeyup = function() {
        var filterText = this.value.toLowerCase();
        var items = filterDropdown.getElementsByClassName('filter-item');
        for (var i = 0; i < items.length; i++) {
          var label = items[i].getElementsByTagName('label')[0];
          if (label.textContent.toLowerCase().indexOf(filterText) > -1) {
            items[i].style.display = '';
          } else {
            items[i].style.display = 'none';
          }
        }
      };
      filterDropdown.appendChild(inputFilter);

      // 「Select All」と「Clear All」ボタンを追加
      var controlDiv = document.createElement('div');
      controlDiv.style.marginBottom = '8px';
      controlDiv.style.textAlign = 'center';
      
      var selectAllBtn = document.createElement('button');
      selectAllBtn.textContent = 'Select All';
      selectAllBtn.onclick = function(e) {
        e.stopPropagation();
        var checkboxes = filterDropdown.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(cb) {
          cb.checked = true;
        });
        applyFilter();
        return false;
      };
      
      var clearAllBtn = document.createElement('button');
      clearAllBtn.textContent = 'Clear All';
      clearAllBtn.onclick = function(e) {
        e.stopPropagation();
        var checkboxes = filterDropdown.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(cb) {
          cb.checked = false;
        });
        applyFilter();
        return false;
      };
      
      controlDiv.appendChild(selectAllBtn);
      controlDiv.appendChild(clearAllBtn);
      filterDropdown.appendChild(controlDiv);

      // 各ユニークな値について、チェックボックスとラベルのリストを作成
      for (var i = 0; i < filterValues.length; i++) {
        var divItem = document.createElement('div');
        divItem.className = 'filter-item';
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = filterValues[i];
        checkbox.onchange = applyFilter;
        // すでに選択済みの場合はチェック状態にする
        if (selectedFilters.indexOf(filterValues[i]) > -1) {
          checkbox.checked = true;
        }
        var label = document.createElement('label');
        label.textContent = filterValues[i];
        divItem.appendChild(checkbox);
        divItem.appendChild(label);
        filterDropdown.appendChild(divItem);
      }

      // ヘッダー要素の位置情報からドロップダウンの表示位置を決定
      var rect = headerElem.getBoundingClientRect();
      filterDropdown.style.top = (rect.bottom + window.scrollY) + 'px';
      filterDropdown.style.left = (rect.left + window.scrollX) + 'px';

      document.body.appendChild(filterDropdown);

      // ★ここで active 状態を更新（再オープン時も反映）
      updateSortIndicatorInDropdown();

      // ドロップダウン外をクリックしたら閉じる
      setTimeout(function(){
        document.addEventListener('click', function handler(e) {
          if (!filterDropdown.contains(e.target) &&
              e.target !== headerElem &&
              !headerElem.contains(e.target)) {
            if (filterDropdown) {
              filterDropdown.parentNode.removeChild(filterDropdown);
              filterDropdown = null;
            }
            document.removeEventListener('click', handler);
          }
        });
      }, 0);
    }

    // ドロップダウンの表示／非表示を切り替え
    function toggleFilterDropdown(colIndex, triggerElem) {
      // 初回なら、対象列のユニークな値を取得
      if (filterValues.length === 0) {
        initFilterValues(colIndex);
      }
      if (filterDropdown) {
        // すでに表示されていれば閉じる
        filterDropdown.parentNode.removeChild(filterDropdown);
        filterDropdown = null;
      } else {
        createFilterDropdown(colIndex, triggerElem);
      }
    }

    // チェックボックスの変更時に、選択された値に合わせてテーブルをフィルタリング
    // ※チェックされた値が存在する場合、その値を含む行のみ表示します
    function applyFilter() {
      selectedFilters = [];
      if (filterDropdown) {
        var checkboxes = filterDropdown.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(cb) {
          if (cb.checked) {
            selectedFilters.push(cb.value);
          }
        });
      }
      var table = document.getElementById('demoTable');
      var tbody = table.tBodies[0];
      for (var i = 0; i < tbody.rows.length; i++) {
        var cellText = tbody.rows[i].cells[0].textContent.trim();
        if (selectedFilters.length > 0 && selectedFilters.indexOf(cellText) > -1) {
          tbody.rows[i].style.display = "";
        } else {
          tbody.rows[i].style.display = "none";
        }
      }
    }

    // 商品名列（列インデックス0）のソート機能（トグル機能付き）
    // 同じ順を再度選択すると初期状態に戻ります
    function sortTable(colIndex, order) {
      var table = document.getElementById('demoTable');
      var tbody = table.tBodies[0];

      // 既に指定の順でソート済みなら、デフォルトの順に戻す
      if (currentSortOrder === order) {
        currentSortOrder = '';
        defaultOrder.forEach(function(row) {
          tbody.appendChild(row);
        });
        updateSortIndicatorInDropdown();
        return;
      }

      currentSortOrder = order;
      // tbody内の全行を配列に変換
      var rowsArray = Array.from(tbody.rows);
      // localeCompare を用いてソート（日本語対応）
      rowsArray.sort(function(a, b) {
        var cellA = a.cells[colIndex].textContent.trim();
        var cellB = b.cells[colIndex].textContent.trim();
        if (order === 'asc') {
          return cellA.localeCompare(cellB, 'ja');
        } else {
          return cellB.localeCompare(cellA, 'ja');
        }
      });
      // ソート済みの順に tbody に再配置
      rowsArray.forEach(function(row) {
        tbody.appendChild(row);
      });
      updateSortIndicatorInDropdown();
    }

    // ドロップダウン内のソートオプションの見た目を更新する関数
    function updateSortIndicatorInDropdown() {
      if (!filterDropdown) return;
      var ascBtn = filterDropdown.querySelector('.sort-option[data-order="asc"]');
      var descBtn = filterDropdown.querySelector('.sort-option[data-order="desc"]');
      if (ascBtn) ascBtn.classList.remove('active');
      if (descBtn) descBtn.classList.remove('active');
      if (currentSortOrder === 'asc' && ascBtn) {
        ascBtn.classList.add('active');
      } else if (currentSortOrder === 'desc' && descBtn) {
        descBtn.classList.add('active');
      }
    }
  </script>
</body>
</html>
