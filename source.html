<!doctype html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Source Snippet</title>
  <meta name="description" content="Source Sni[[et Writen by Ishizaki">
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0e1116; 
      --card:#121722;
      --fg:#e6edf3;
      --muted:#a7b1be;
      --border:#202635;
      --accent:#6aa9ff;
      --code-bg:#0b1320;
      --code-fg:#dbe6ff;
      --radius:12px;
      --tap:44px;
      --pad:clamp(14px,3.2vw,22px);
      --shadow:0 1px 0 var(--border), 0 10px 24px rgba(0,0,0,.25);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0; background:var(--bg); color:var(--fg);
      font: clamp(15px,1.7vw,16.5px)/1.7 ui-sans-serif,system-ui,-apple-system,
            "Segoe UI",Roboto,"Helvetica Neue","Noto Sans JP",
            "Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Arial,sans-serif;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    :focus-visible{outline:2px solid var(--accent);outline-offset:3px;border-radius:8px}

    .container{
      max-width:960px;margin-inline:auto;padding:var(--pad);
      padding-left:max(var(--pad),env(safe-area-inset-left));
      padding-right:max(var(--pad),env(safe-area-inset-right));
    }

    header{
      position:sticky; top:0; z-index:10; background:var(--bg);
      border-bottom:1px solid var(--border);
      padding-top:env(safe-area-inset-top);
    }
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:56px}
    h1{margin:0;font-size:clamp(1rem,2.6vw,1.15rem);letter-spacing:.2px}
    .muted{color:var(--muted);font-size:.92rem}

    .controls{display:flex;gap:8px;align-items:center}
    #search{
      width:min(100%,520px); height:var(--tap);
      padding:10px 12px; border:1px solid var(--border); border-radius:999px;
      background:var(--card); color:var(--fg);
      outline:none;
    }

    main{padding-block: clamp(8px,2.5vw,16px)}
    #snippets{display:grid;gap:clamp(12px,2.5vw,16px)}
    article{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding: clamp(12px,2.6vw,16px);
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h2{margin:0;font-size:clamp(.98rem,2.5vw,1.05rem)}
    h2[id]{scroll-margin-top:72px}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:.8rem;color:var(--muted);padding:2px 10px;border:1px solid var(--border);border-radius:999px}

    pre{
      margin:10px 0 0; padding:12px; overflow:auto;
      background:var(--code-bg); color:var(--code-fg);
      border:1px solid var(--border); border-radius:10px;
      -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
    }
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace;
         font-size:clamp(.88rem,2.3vw,.95rem)}

    .copy{
      border:1px solid var(--border); background:transparent; color:var(--fg);
      border-radius:10px; padding:0 12px; height:var(--tap); min-width:calc(var(--tap) * 1.4);
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .copy:hover{border-color:var(--accent)}

    #empty{
      display:none; margin-top:10px; text-align:center;
      border:1px dashed var(--border); border-radius:10px; padding:18px; color:var(--muted);
    }
    footer{border-top:1px solid var(--border);margin-top:clamp(12px,3vw,20px);padding-top:10px;padding-bottom:env(safe-area-inset-bottom)}

    @media (min-width:720px){ #snippets{gap:18px} }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="head">
      <h1>Source Snippet</h1>
      <div class="controls">
        <input id="search" type="search" inputmode="search" enterkeyhint="search"
               placeholder="キーワード / タグで検索" autocomplete="off" />
      </div>
    </div>
  </div>
</header>

<main class="container" role="main">
  <section id="snippets" aria-live="polite">

    <article>
      <div class="row">
        <h2 id="ps-get-path">実行PCのIPのみを表示（PowerShell）</h2>
        <div class="tags"><span class="tag">powershell</span><span class="tag">windows</span></div>
      </div>
      <pre><code class="language-powershell">(Get-NetIPAddress -AddressFamily IPv4 |
      Where-Object {$_.IPAddress -notlike '169.*' -and $_.IPAddress -ne '127.0.0.1'}).IPAddress</code></pre>
      <div class="row" style="margin-top:8px">
        <button class="copy" data-for="ps-get-path" aria-label="コードをコピー">コピー</button>
      </div>
    </article>

    <article>
      <div class="row">
        <h2 id="ps-allow-rdp">リモートデスクトップの許可（PowerShell）</h2>
        <div class="tags"><span class="tag">powershell</span><span class="tag">windows</span></div>
      </div>
      <pre><code class="language-powershell">$sg=(powercfg /getactivescheme) -replace '.*:\s+|\s+\(.*','';$st=@(@{n='ディスプレイの電源を切る（バッテリ駆動）';g='SUB_VIDEO';k='3c0bc021-c8a8-4e07-a973-6b14cbcb2b7e';m='dc'},@{n='ディスプレイの電源を切る（電源に接続）';g='SUB_VIDEO';k='3c0bc021-c8a8-4e07-a973-6b14cbcb2b7e';m='ac'},@{n='スリープ状態にする（バッテリ駆動）';g='SUB_SLEEP';k='29f6c1db-86da-48c5-9fdb-f2b67b1f44da';m='dc'},@{n='スリープ状態にする（電源に接続）';g='SUB_SLEEP';k='29f6c1db-86da-48c5-9fdb-f2b67b1f44da';m='ac'});function gt($g,$k,$m){$t=New-TemporaryFile;powercfg -query SCHEME_CURRENT $g $k > $t.FullName 2>$null;$l=Get-Content $t.FullName;Remove-Item $t -Force;if($m -eq 'ac' -and ($l -match 'AC.*インデックス.*:\s*0x([0-9a-fA-F]+)')){[math]::Round(([convert]::ToInt32($matches[1],16))/60)}elseif($m -eq 'dc' -and ($l -match 'DC.*インデックス.*:\s*0x([0-9a-fA-F]+)')){[math]::Round(([convert]::ToInt32($matches[1],16))/60)}else{-1}};Write-Host "`n🔎 現在の設定:";$st|%{ $_.before=gt $_.g $_.k $_.m;Write-Host ("  {0}: {1} 分" -f $_.n,$_.before)};$sec=0;Write-Host "`n🔧 一律で 0 分に変更中...";$st|%{if($_.m -eq 'ac'){powercfg -setacvalueindex $sg $_.g $_.k $sec}else{powercfg -setdcvalueindex $sg $_.g $_.k $sec}};powercfg -S $sg; $st|%{ $_.after=gt $_.g $_.k $_.m};Write-Host "`n✅ 変更後:";$st|%{Write-Host ("  {0}: {1} 分" -f $_.n,$_.after)};Write-Host "`n⏹ 続行するには何かキーを押してください（画面をクリアして終了します）...";try{$null=$Host.UI.RawUI.ReadKey('NoEcho,IncludeKeyDown')}catch{Read-Host '> Enter を押してください'|Out-Null};Clear-Host;exit
            </code></pre>
      <div class="row" style="margin-top:8px">
        <button class="copy" data-for="ps-allow-rdp" aria-label="コードをコピー">コピー</button>
      </div>
    </article>


    <article>
      <div class="row">
        <h2 id="ps-change-battery-plan">リモートデスクトップの許可（PowerShell）</h2>
        <div class="tags"><span class="tag">powershell</span><span class="tag">windows</span></div>
      </div>
      <pre><code class="language-powershell">
# System_LocateがJP限定です。
# 日本にいる人向けの設定更新になります。
function Admin {
    $identity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($identity)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

# 管理者でなければ再起動
if (-not (Admin)) {
    Write-Host "🔁 管理者権限で再起動します..."
    $script = $MyInvocation.MyCommand.Definition
    Start-Process powershell.exe -ArgumentList "-NoProfile -ExecutionPolicy Bypass -File `"$script`"" -Verb RunAs
    exit
}

# 現在のプランID取得
$schemeGuid = (powercfg /getactivescheme) -replace '.*:\s+|\s+\(.*', ''

# 設定一覧（GUIDベースで定義）
$settings = @(
    @{ id = "1"; name = "ディスプレイの電源を切る（バッテリ駆動）"; group = "SUB_VIDEO"; subKey = "3c0bc021-c8a8-4e07-a973-6b14cbcb2b7e"; mode = "dc" },
    @{ id = "2"; name = "ディスプレイの電源を切る（電源に接続）"; group = "SUB_VIDEO"; subKey = "3c0bc021-c8a8-4e07-a973-6b14cbcb2b7e"; mode = "ac" },
    @{ id = "3"; name = "スリープ状態にする（バッテリ駆動）"; group = "SUB_SLEEP"; subKey = "29f6c1db-86da-48c5-9fdb-f2b67b1f44da"; mode = "dc" },
    @{ id = "4"; name = "スリープ状態にする（電源に接続）"; group = "SUB_SLEEP"; subKey = "29f6c1db-86da-48c5-9fdb-f2b67b1f44da"; mode = "ac" }
)

# 現在値取得
function Get-TimeoutValue {
    param (
        [string]$subgroup,
        [string]$settingGuid,
        [string]$mode
    )
    $tempFile = New-TemporaryFile
    powercfg -query SCHEME_CURRENT $subgroup $settingGuid > $tempFile.FullName 2>$null
    $lines = Get-Content $tempFile.FullName
    Remove-Item $tempFile -Force

    foreach ($line in $lines) {
        if ($mode -eq "ac" -and $line -match "AC.*インデックス.*:\s*0x([0-9a-fA-F]+)") {
            return [math]::Round(([convert]::ToInt32($matches[1], 16)) / 60)
        }
        if ($mode -eq "dc" -and $line -match "DC.*インデックス.*:\s*0x([0-9a-fA-F]+)") {
            return [math]::Round(([convert]::ToInt32($matches[1], 16)) / 60)
        }
    }

    return -1
}

# 表示
Write-Host "`n🔎 現在の設定:"
foreach ($s in $settings) {
    $s.minutes = Get-TimeoutValue $s.group $s.subKey $s.mode
    Write-Host "  [$($s.id)] $($s.name): $($s.minutes) 分"
}
Write-Host "  [0] やめる（終了）"
Write-Host "  [5] 現在の設定を再読み込み"
Write-Host "  [6] すべて「0 分」にする"
Write-Host "  [7] すべて「1 分」にする"

# 設定変更ループ
do {
    $choice = Read-Host "`n変更したい設定の番号を選んでください（0で終了 / 5で再読み込み）"
    
    if ($choice -eq "0") {
        Write-Host "`n👋 終了します。"
        break
    }

    if ($choice -eq "5") {
        Write-Host "`n🔄 設定を再取得中..."
        foreach ($s in $settings) {
            $s.minutes = Get-TimeoutValue $s.group $s.subKey $s.mode
            Write-Host "  [$($s.id)] $($s.name): $($s.minutes) 分"
        }
        continue
    }

    if ($choice -eq "6" -or $choice -eq "7") {
        $newMinutes = if ($choice -eq "6") { 0 } else { 1 }
        $seconds = $newMinutes * 60
        Write-Host "`n🔧 すべての設定を $newMinutes 分に変更中..."

        foreach ($s in $settings) {
            if ($s.mode -eq "ac") {
                powercfg -setacvalueindex $schemeGuid $s.group $s.subKey $seconds
            } else {
                powercfg -setdcvalueindex $schemeGuid $s.group $s.subKey $seconds
            }
        }

        powercfg -S $schemeGuid
        Write-Host "✅ 一括設定完了！"

        foreach ($s in $settings) {
            $s.minutes = Get-TimeoutValue $s.group $s.subKey $s.mode
        }
        continue
    }

    $target = $settings | Where-Object { $_.id -eq $choice }
    if (-not $target) {
        Write-Host "❌ 無効な選択です。"
        continue
    }

    Write-Host "`n⏲ 新しい時間を入力（単位：分）"
    Write-Host "  ※ 0 を入力すると『適用しない』になります。"
    do {
        $input = Read-Host "現在値: $($target.minutes) 分 → 新しい値（分）を入力してください"
    } until ($input -match '^\d+$')

    $newMinutes = [int]$input
    $seconds = $newMinutes * 60

    Write-Host "🛠 設定変更中: $($target.name) → $newMinutes 分..."

    if ($target.mode -eq "ac") {
        powercfg -setacvalueindex $schemeGuid $target.group $target.subKey $seconds
    } else {
        powercfg -setdcvalueindex $schemeGuid $target.group $target.subKey $seconds
    }

    powercfg -S $schemeGuid  # 変更を有効にする

    Write-Host "✅ 設定完了！"

    # 更新後の値を再取得
    $target.minutes = Get-TimeoutValue $target.group $target.subKey $target.mode

} while ($true)        
            </code></pre>
      <div class="row" style="margin-top:8px">
        <button class="copy" data-for="ps-change-battery-plan" aria-label="コードをコピー">コピー</button>
      </div>
    </article>
    <article>
      <div class="row">
        <h2 id="ps-listen-ports">待ち受けポートを確認（PowerShell）</h2>
        <div class="tags"><span class="tag">powershell</span><span class="tag">network</span></div>
      </div>
      <pre><code class="language-powershell">Get-NetTCPConnection -State Listen |
  Sort-Object -Property LocalPort |
  Select-Object LocalAddress,LocalPort,OwningProcess</code></pre>
      <div class="row" style="margin-top:8px">
        <button class="copy" data-for="ps-listen-ports" aria-label="コードをコピー">コピー</button>
      </div>
    </article>

    <article>
      <div class="row">
        <h2 id="git-amend">直前コミットのメッセージを直す（Git）</h2>
        <div class="tags"><span class="tag">git</span><span class="tag">shell</span></div>
      </div>
      <pre><code class="language-bash">git commit --amend -m "fix: 正しいメッセージに更新"</code></pre>
      <div class="row" style="margin-top:8px">
        <button class="copy" data-for="git-amend" aria-label="コードをコピー">コピー</button>
      </div>
    </article>

  </section>

  <div id="empty">該当する項目がありません。</div>

  <footer class="muted">Copyright Ishizaki 2025</footer>
</main>

<script>
  (function(){
    const q=document.getElementById('search');
    const list=document.getElementById('snippets');
    const empty=document.getElementById('empty');
    let t=0;
    function filter(){
      const terms=(q.value||'').toLowerCase().split(/\s+/).filter(Boolean);
      let shown=0;
      list.querySelectorAll('article').forEach(a=>{
        const hay=(a.textContent+' '+(a.dataset.tags||'')).toLowerCase();
        const ok=terms.every(t=>hay.includes(t));
        a.style.display=ok?'':'none';
        if(ok) shown++;
      });
      empty.style.display= shown? 'none':'block';
      history.replaceState(null,'',location.pathname+(q.value?('#q='+encodeURIComponent(q.value)):''));
    }
    q.addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(filter, 80); });
    if(location.hash.startsWith('#q=')){ q.value=decodeURIComponent(location.hash.slice(3)); filter(); }
  })();

  (function(){
    function getCode(id){
      const h=document.getElementById(id);
      const pre=h?.parentElement?.nextElementSibling;
      return pre? pre.innerText : '';
    }
    document.querySelectorAll('.copy').forEach(b=>{
      b.addEventListener('click',async()=>{
        const text=getCode(b.dataset.for);
        try{
          await navigator.clipboard.writeText(text);
          const t=b.textContent; b.textContent='✓ コピーしました';
          setTimeout(()=>b.textContent=t, 1100);
        }catch(e){ alert('コピーに失敗: '+e); }
      });
    });
  })();
</script>
</body>
</html>
